# Threat Model — Frontend Foundation v1.0

## Contexto
- **Release / Sprint**: v1.0 (Fundação Frontend)
- **Data da sessão**: 2025-10-19
- **Facilitador(a)**: Maria Souza (Segurança de Produto)
- **Participantes**: João Lima (Frontend Foundation Guild), Ana Ribeiro (SRE), Lucas Martins (Privacy/LGPD), Carla Nunes (Backend Tenancy)
- **Escopo**: SPA React multi-tenant (FSD), pipelines CI/CD (Chromatic, Lighthouse, security), integração TanStack Query + Zustand, CSP/Trusted Types, RLS no backend e coleta OTEL Web
- **Referências**: `specs/002-f-10-fundacao/spec.md`, `specs/002-f-10-fundacao/plan.md`, `docs/runbooks/frontend-foundation.md`

## Arquitetura & Fluxos de Dados
- **Diagrama atualizado**: _Pendência_ — exportar para Structurizr conforme ADR-012 (responsável: João Lima)
- **Superfícies de ataque**: CDN SPA → API Gateway Django (`/api/v1/tenants/*`, `/features/scaffold`), scripts CLI (`foundation:scaffold`, `foundation:otel`), workers Celery (Chromatic/Lighthouse), endpoints OTEL collector
- **Dados sensíveis**: `tenant_id`, tokens Tailwind, métricas SC-00x, baggage OTEL, dados PII mascarados (CPF, email), chaves Vault `FOUNDATION_*`
- **Dependências externas**: GitHub Actions, Chromatic, k6 Cloud (fallback), Vault Transit, Redis, PostgreSQL (pgcrypto), OTEL Collector

## Inventário de Ativos
| Ativo | Descrição | Confidencialidade | Integridade | Disponibilidade | Observações |
|-------|-----------|-------------------|-------------|-----------------|-------------|
| SPA React (frontend) | Interface multi-tenant servida via CDN | Alta (PII mascarada pode vazar) | Média | Alta | Governada por CSP/Trusted Types |
| API Django foundation | Endpoints `/features/scaffold`, `/tenant-metrics` | Alta | Alta | Alta | Protegido por RLS e pgcrypto |
| Estado TanStack/Zustand | Cache e stores de estado por tenant | Média | Alta | Alta | Reset obrigatório na troca de tenant |
| Telemetria OTEL | Traces com baggage `tenant_id` | Alta | Alta | Média | Deve mascarar PII antes do export |
| Pipelines CI | Jobs GitHub Actions (lint, security, performance) | Média | Alta | Alta | Fail-closed em release |
| Vault Transit | Gestão de chaves CSP/Trusted Types/pgcrypto | Alta | Alta | Média | Acesso auditado |

## STRIDE — Ameaças de Segurança
| ID | Categoria (STRIDE) | Ativo / Fluxo | Descrição da ameaça | Vetor / Pré-condição | Impacto | Probabilidade | Mitigação proposta | Dono | Status |
|----|--------------------|---------------|----------------------|----------------------|---------|---------------|---------------------|------|--------|
| STR-001 | Spoofing | SPA → API (`X-Tenant-Id`) | Agente malicioso modifica header para acessar dados de outro tenant | Interceptar requisição frontend ou automatizar chamadas sem middleware tenancy | Alto (exfiltração multi-tenant) | Baixa | Validar `X-Tenant-Id` via RLS (já ativo) + assinatura HMAC-SHA256 (chave raiz por ambiente em Vault/KMS, HKDF por tenant, rotação 90d, auditoria de uso por tenant) em chamadas privilegiadas | Carla Nunes | Em acompanhamento |
| STR-002 | Information Disclosure | Telemetria OTEL | PII aparece em atributos/exceções antes do mascaramento | Falha de implementação em `sanitizeTelemetryAttributes` ou novo campo não catalogado | Alto | Média | Expandir testes automatizados de mascaramento + monitorar spans com baggage suspeita no collector | João Lima | Aberto |
| STR-003 | Denial of Service | Pipelines CI (Chromatic/Lighthouse) | Execuções paralelas exaurem quotas, bloqueando deploys críticos | Alta carga ou ataque a tokens CI | Médio | Média | Rate limiting nos jobs + alertas FinOps quando custos >80% do budget | Ana Ribeiro | Planejado |

## LINDDUN — Ameaças de Privacidade
| ID | Categoria (LINDDUN) | Dados afetados | Descrição da ameaça | Vetor / Cenário | Impacto (LGPD) | Mitigação proposta | Dono | Status |
|----|---------------------|---------------|----------------------|-----------------|----------------|---------------------|------|--------|
| LIN-001 | Identifiability | Logs/Tracing | Correlação de baggage `tenant_id` com identificadores únicos de usuário final | Correlação cruzada entre OTEL e logs de parceiro | Alto | Limitar campos exportados, anonimizar IDs de usuário antes de enviar para OTEL, revisar retention no collector | Lucas Martins | Em andamento |
| LIN-002 | Disclosure of information | Tokens Tailwind | Tokens contém branding sensível ou dados internos (logos, códigos) acessíveis via leak | Comprometimento do CDN ou build artefact | Médio | Criptografar payload sensível em `TenantThemeToken` (pgcrypto) e limitar exposição pública | Carla Nunes | Resolvido |
| LIN-003 | Non-compliance | Métricas SC-005 | Ausência de consentimento documentado para coleta de métricas de sucesso | Falha na atualização de runbook/avisos de privacidade | Médio | Atualizar runbook e incluir seção de consentimento nas páginas afetadas | Maria Souza | Planejado |

## Controles Existentes
- CSP `strict-dynamic` com nonce rotativo e Trusted Types (`foundation-ui`)
- Política de reset de estado TanStack/Zustand na troca de tenant (limpa caches)
- Pgcrypto + RLS fortalecida (`backend/apps/tenancy`)
- Testes automatizados (`frontend/tests/otel/masking.spec.ts`, `frontend/tests/security/csp_trusted_types.spec.ts`)
- Pipeline `security` agregado com Semgrep, ZAP, pip-audit, Safety, pnpm audit, SBOM CycloneDX

## Mitigation Status
| Ação | Owner | Prazo | Referência (issue/PR) | Status |
|------|-------|-------|------------------------|--------|
| Expandir suíte de mascaramento OTEL para novos atributos | João Lima | 2025-11-05 | <!-- issue/link --> | Aberto |
| Aplicar política HMAC-SHA256 para `X-Tenant-Id` privilegiado (chave raiz por ambiente em Vault/KMS, HKDF por tenant, rotação 90d, auditoria por tenant) | Carla Nunes | 2025-11-12 | <!-- issue/link --> | Em andamento |
| Atualizar runbook com consentimento SC-005 | Maria Souza | 2025-10-31 | <!-- issue/link --> | Em andamento |

## Gaps & Ações Prioritárias
- Implementar/verificar assinatura HMAC-SHA256 nas chamadas administrativas (`@SC-005`) conforme política definida (Vault/KMS raiz por ambiente, HKDF por tenant, rotação 90d, auditoria por tenant)
- Integrar alertas FinOps com monitoramento de consumo Chromatic/Lighthouse em tempo real
- Definir processo de revisão trimestral do threat model com guilda de privacidade

## Evidências e Artefatos
- Logs de execução `pnpm foundation:otel verify` (build #1021)
- Resultados da bateria `frontend/tests/otel/masking.spec.ts`
- Planilha de acompanhamento FinOps (pasta compartilhada: `FinOps/FrontendFoundation`)

## Aprovação
- **Segurança**:
- **Frontend Foundation Guild**:
- **SRE**:
