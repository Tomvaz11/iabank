{
  "$schema": "https://json-schema.org/draft/2020-12/schema",
  "$id": "https://iabank.local/contracts/seed-profile.schema.json",
  "title": "Seed Profile Manifest v1",
  "description": "Manifesto v1 para execu\u00e7\u00f5es determin\u00edsticas de seed_data (baseline/carga/DR/canary) multi-tenant.",
  "type": "object",
  "additionalProperties": false,
  "required": [
    "metadata",
    "mode",
    "reference_datetime",
    "window",
    "volumetry",
    "rate_limit",
    "backoff",
    "budget",
    "ttl",
    "slo",
    "integrity"
  ],
  "properties": {
    "metadata": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "tenant",
        "environment",
        "profile",
        "version",
        "schema_version",
        "salt_version"
      ],
      "properties": {
        "tenant": {
          "type": "string",
          "minLength": 1
        },
        "environment": {
          "type": "string",
          "enum": [
            "dev",
            "homolog",
            "staging",
            "perf",
            "dr",
            "prod"
          ]
        },
        "profile": {
          "type": "string",
          "minLength": 1
        },
        "version": {
          "type": "string",
          "description": "Vers\u00e3o SemVer do manifesto.",
          "pattern": "^[0-9]+\\.[0-9]+\\.[0-9]+(-[0-9A-Za-z\\.-]+)?$"
        },
        "schema_version": {
          "type": "string",
          "enum": [
            "v1"
          ]
        },
        "salt_version": {
          "type": "string",
          "minLength": 1
        }
      }
    },
    "mode": {
      "type": "string",
      "enum": [
        "baseline",
        "carga",
        "dr",
        "canary"
      ]
    },
    "reference_datetime": {
      "type": "string",
      "format": "date-time",
      "description": "ISO 8601 UTC; mudan\u00e7a \u00e9 breaking e exige reseed."
    },
    "window": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "start_utc",
        "end_utc"
      ],
      "properties": {
        "start_utc": {
          "type": "string",
          "pattern": "^\\d{2}:\\d{2}$",
          "description": "HH:MM UTC; \u00fanica janela di\u00e1ria."
        },
        "end_utc": {
          "type": "string",
          "pattern": "^\\d{2}:\\d{2}$",
          "description": "HH:MM UTC; se end < start, cruza meia-noite."
        }
      }
    },
    "volumetry": {
      "type": "object",
      "description": "Caps Q11 por entidade; rejeita chaves fora do cat\u00e1logo.",
      "additionalProperties": false,
      "required": [
        "tenant_users",
        "customers",
        "addresses",
        "consultants",
        "bank_accounts",
        "account_categories",
        "suppliers",
        "loans",
        "installments",
        "financial_transactions",
        "limits",
        "contracts"
      ],
      "properties": {
        "tenant_users": {
          "$ref": "#/$defs/volumetryEntry"
        },
        "customers": {
          "$ref": "#/$defs/volumetryEntry"
        },
        "addresses": {
          "$ref": "#/$defs/volumetryEntry"
        },
        "consultants": {
          "$ref": "#/$defs/volumetryEntry"
        },
        "bank_accounts": {
          "$ref": "#/$defs/volumetryEntry"
        },
        "account_categories": {
          "$ref": "#/$defs/volumetryEntry"
        },
        "suppliers": {
          "$ref": "#/$defs/volumetryEntry"
        },
        "loans": {
          "$ref": "#/$defs/volumetryEntry"
        },
        "installments": {
          "$ref": "#/$defs/volumetryEntry"
        },
        "financial_transactions": {
          "$ref": "#/$defs/volumetryEntry"
        },
        "limits": {
          "$ref": "#/$defs/volumetryEntry"
        },
        "contracts": {
          "$ref": "#/$defs/volumetryEntry"
        }
      }
    },
    "rate_limit": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "limit",
        "window_seconds"
      ],
      "properties": {
        "limit": {
          "type": "integer",
          "minimum": 1
        },
        "window_seconds": {
          "type": "integer",
          "minimum": 1
        },
        "burst": {
          "type": "integer",
          "minimum": 1
        }
      },
      "description": "Limite de requests por janela; burst opcional deve ser >= limit."
    },
    "backoff": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "base_seconds",
        "jitter_factor",
        "max_retries",
        "max_interval_seconds"
      ],
      "properties": {
        "base_seconds": {
          "type": "integer",
          "minimum": 1
        },
        "jitter_factor": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "max_retries": {
          "type": "integer",
          "minimum": 0
        },
        "max_interval_seconds": {
          "type": "integer",
          "minimum": 1
        }
      },
      "allOf": [
        {
          "description": "max_interval_seconds deve ser >= base_seconds.",
          "properties": {
            "max_interval_seconds": {
              "minimum": 1
            }
          }
        }
      ]
    },
    "budget": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "cost_cap_brl",
        "error_budget_pct"
      ],
      "properties": {
        "cost_cap_brl": {
          "type": "number",
          "minimum": 0,
          "multipleOf": 0.01
        },
        "error_budget_pct": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        },
        "cost_model_version": {
          "type": "string",
          "minLength": 1,
          "description": "Versão do cost-model FinOps declarada no manifesto."
        }
      }
    },
    "ttl": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "baseline_days",
        "carga_days",
        "dr_days"
      ],
      "properties": {
        "baseline_days": {
          "type": "integer",
          "minimum": 0
        },
        "carga_days": {
          "type": "integer",
          "minimum": 0
        },
        "dr_days": {
          "type": "integer",
          "minimum": 0
        }
      }
    },
    "slo": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "p95_target_ms",
        "p99_target_ms",
        "throughput_target_rps"
      ],
      "properties": {
        "p95_target_ms": {
          "type": "integer",
          "minimum": 1
        },
        "p99_target_ms": {
          "type": "integer",
          "minimum": 1
        },
        "throughput_target_rps": {
          "type": "number",
          "minimum": 0.1
        }
      }
    },
    "canary": {
      "description": "Obrigat\u00f3rio quando mode = canary.",
      "oneOf": [
        {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "percentage"
          ],
          "properties": {
            "percentage": {
              "type": "number",
              "minimum": 0,
              "maximum": 100
            }
          }
        },
        {
          "type": "object",
          "additionalProperties": false,
          "required": [
            "tenants"
          ],
          "properties": {
            "tenants": {
              "type": "array",
              "items": {
                "type": "string",
                "minLength": 1
              },
              "minItems": 1,
              "uniqueItems": true
            }
          }
        }
      ]
    },
    "integrity": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "manifest_hash"
      ],
      "properties": {
        "manifest_hash": {
          "type": "string",
          "pattern": "^[a-fA-F0-9]{64}$",
          "description": "sha256 do manifesto bruto."
        },
        "worm_proof": {
          "type": "string",
          "minLength": 1,
          "description": "Evidência WORM necessária para modos carga/DR."
        }
      }
    },
    "caps_override": {
      "type": "object",
      "description": "Opcional para ambientes de teste controlados; mesmas chaves de volumetry.",
      "additionalProperties": {
        "type": "integer",
        "minimum": 1
      }
    }
  },
  "allOf": [
    {
      "if": {
        "properties": {
          "mode": {
            "const": "canary"
          }
        }
      },
      "then": {
        "required": [
          "canary"
        ]
      },
      "else": {
        "properties": {
          "canary": {
            "not": {}
          }
        }
      }
    }
  ],
  "examples": [
    {
      "metadata": {
        "tenant": "tenant-a",
        "environment": "staging",
        "profile": "baseline",
        "version": "1.1.0",
        "schema_version": "v1",
        "salt_version": "2025-q1"
      },
      "mode": "baseline",
      "reference_datetime": "2025-01-10T00:00:00Z",
      "window": {
        "start_utc": "22:00",
        "end_utc": "06:00"
      },
      "volumetry": {
        "tenant_users": {
          "cap": 25
        },
        "customers": {
          "cap": 500
        },
        "addresses": {
          "cap": 750
        },
        "consultants": {
          "cap": 50
        },
        "bank_accounts": {
          "cap": 600
        },
        "account_categories": {
          "cap": 100
        },
        "suppliers": {
          "cap": 150
        },
        "loans": {
          "cap": 1000
        },
        "installments": {
          "cap": 10000
        },
        "financial_transactions": {
          "cap": 20000
        },
        "limits": {
          "cap": 500
        },
        "contracts": {
          "cap": 750
        }
      },
      "rate_limit": {
        "limit": 960,
        "window_seconds": 60,
        "burst": 1200
      },
      "backoff": {
        "base_seconds": 2,
        "jitter_factor": 0.4,
        "max_retries": 6,
        "max_interval_seconds": 45
      },
      "budget": {
        "cost_cap_brl": 125.0,
        "error_budget_pct": 6.0
      },
      "ttl": {
        "baseline_days": 30,
        "carga_days": 7,
        "dr_days": 3
      },
      "slo": {
        "p95_target_ms": 5000,
        "p99_target_ms": 8000,
        "throughput_target_rps": 10.0
      },
      "integrity": {
        "manifest_hash": "8c88eeda7fe51bd4d3599fc26874e82861af6f58bb15b5f5069e7d52d5d2298f"
      }
    },
    {
      "metadata": {
        "tenant": "tenant-a",
        "environment": "perf",
        "profile": "carga",
        "version": "1.0.0",
        "schema_version": "v1",
        "salt_version": "2025-q1"
      },
      "mode": "carga",
      "reference_datetime": "2025-02-01T00:00:00Z",
      "window": {
        "start_utc": "21:00",
        "end_utc": "05:00"
      },
      "volumetry": {
        "tenant_users": {
          "cap": 50
        },
        "customers": {
          "cap": 2500
        },
        "addresses": {
          "cap": 3750
        },
        "consultants": {
          "cap": 150
        },
        "bank_accounts": {
          "cap": 3000
        },
        "account_categories": {
          "cap": 300
        },
        "suppliers": {
          "cap": 750
        },
        "loans": {
          "cap": 5000
        },
        "installments": {
          "cap": 50000
        },
        "financial_transactions": {
          "cap": 100000
        },
        "limits": {
          "cap": 2500
        },
        "contracts": {
          "cap": 3750
        }
      },
      "rate_limit": {
        "limit": 960,
        "window_seconds": 60,
        "burst": 1200
      },
      "backoff": {
        "base_seconds": 2,
        "jitter_factor": 0.45,
        "max_retries": 7,
        "max_interval_seconds": 60
      },
      "budget": {
        "cost_cap_brl": 125.0,
        "error_budget_pct": 8.0
      },
      "ttl": {
        "baseline_days": 30,
        "carga_days": 7,
        "dr_days": 3
      },
      "slo": {
        "p95_target_ms": 8000,
        "p99_target_ms": 12000,
        "throughput_target_rps": 20.0
      },
      "integrity": {
        "manifest_hash": "2248ea9782ed4fa3f3842f87a1f7f8af05394f8160eb903546bf62bd246b2dc2"
      }
    },
    {
      "metadata": {
        "tenant": "tenant-a",
        "environment": "dr",
        "profile": "dr-recovery",
        "version": "2.0.0",
        "schema_version": "v1",
        "salt_version": "2025-q1"
      },
      "mode": "dr",
      "reference_datetime": "2025-02-10T00:00:00Z",
      "window": {
        "start_utc": "23:00",
        "end_utc": "04:00"
      },
      "volumetry": {
        "tenant_users": {
          "cap": 50
        },
        "customers": {
          "cap": 2500
        },
        "addresses": {
          "cap": 3750
        },
        "consultants": {
          "cap": 150
        },
        "bank_accounts": {
          "cap": 3000
        },
        "account_categories": {
          "cap": 300
        },
        "suppliers": {
          "cap": 750
        },
        "loans": {
          "cap": 5000
        },
        "installments": {
          "cap": 50000
        },
        "financial_transactions": {
          "cap": 100000
        },
        "limits": {
          "cap": 2500
        },
        "contracts": {
          "cap": 3750
        }
      },
      "rate_limit": {
        "limit": 960,
        "window_seconds": 60,
        "burst": 1200
      },
      "backoff": {
        "base_seconds": 3,
        "jitter_factor": 0.45,
        "max_retries": 7,
        "max_interval_seconds": 60
      },
      "budget": {
        "cost_cap_brl": 125.0,
        "error_budget_pct": 8.0
      },
      "ttl": {
        "baseline_days": 30,
        "carga_days": 7,
        "dr_days": 3
      },
      "slo": {
        "p95_target_ms": 9000,
        "p99_target_ms": 13000,
        "throughput_target_rps": 16.0
      },
      "integrity": {
        "manifest_hash": "03d7ffe6a6f4ff54cc5b15e6c0507a02bb6aac9cbc77dec7466841ff7a3e2647"
      }
    },
    {
      "metadata": {
        "tenant": "tenant-a",
        "environment": "staging",
        "profile": "canary-10",
        "version": "1.1.0",
        "schema_version": "v1",
        "salt_version": "2025-q1"
      },
      "mode": "canary",
      "reference_datetime": "2025-01-10T00:00:00Z",
      "window": {
        "start_utc": "22:00",
        "end_utc": "06:00"
      },
      "volumetry": {
        "tenant_users": {
          "cap": 25
        },
        "customers": {
          "cap": 500
        },
        "addresses": {
          "cap": 750
        },
        "consultants": {
          "cap": 50
        },
        "bank_accounts": {
          "cap": 600
        },
        "account_categories": {
          "cap": 100
        },
        "suppliers": {
          "cap": 150
        },
        "loans": {
          "cap": 1000
        },
        "installments": {
          "cap": 10000
        },
        "financial_transactions": {
          "cap": 20000
        },
        "limits": {
          "cap": 500
        },
        "contracts": {
          "cap": 750
        }
      },
      "rate_limit": {
        "limit": 960,
        "window_seconds": 60,
        "burst": 1200
      },
      "backoff": {
        "base_seconds": 2,
        "jitter_factor": 0.4,
        "max_retries": 6,
        "max_interval_seconds": 45
      },
      "budget": {
        "cost_cap_brl": 125.0,
        "error_budget_pct": 6.0
      },
      "ttl": {
        "baseline_days": 30,
        "carga_days": 7,
        "dr_days": 3
      },
      "slo": {
        "p95_target_ms": 5000,
        "p99_target_ms": 8000,
        "throughput_target_rps": 10.0
      },
      "integrity": {
        "manifest_hash": "07251dd31f70e2989d398298010d107a2aff8ece3eb7d78c529ca620d6c69380"
      },
      "canary": {
        "percentage": 10
      }
    }
  ],
  "$defs": {
    "volumetryEntry": {
      "type": "object",
      "additionalProperties": false,
      "required": [
        "cap"
      ],
      "properties": {
        "cap": {
          "type": "integer",
          "minimum": 1
        },
        "target_pct": {
          "type": "number",
          "minimum": 0,
          "maximum": 100
        }
      }
    }
  }
}
