name: Quick Perf+Security Check

on:
  workflow_dispatch:
    inputs:
      ref:
        description: Git ref (branch or SHA) to checkout
        required: false
        default: main

env:
  PNPM_VERSION: 9.12.2
  NODE_VERSION: 20.17.0

jobs:
  performance:
    name: Performance Budgets (quick)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: ${{ env.PNPM_VERSION }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm
          cache-dependency-path: pnpm-lock.yaml

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Instalar navegadores Playwright
        run: pnpm --filter @iabank/frontend-foundation exec playwright install --with-deps

      - name: Preparar artefatos
        run: |
          mkdir -p artifacts/lighthouse

      - name: Executar Playwright + Lighthouse budgets (quick)
        env:
          LIGHTHOUSE_ARTIFACT_DIR: ${{ github.workspace }}/artifacts/lighthouse
          LIGHTHOUSE_TARGET_URL: http://localhost:4173/foundation/scaffold?tenant=tenant-alfa&feature=foundation-scaffold
        run: pnpm perf:lighthouse

      - name: Publicar relat√≥rios Lighthouse
        uses: actions/upload-artifact@v4
        with:
          name: performance-lighthouse-budgets
          path: |
            artifacts/lighthouse
            observabilidade/data/lighthouse-latest.json

  security_safety:
    name: Safety JSON Valid (quick)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Poetry (pin 1.8.x)
        run: |
          python -m pip install --upgrade pip
          python -m pip install poetry==1.8.3

      - name: Poetry lock/install
        run: |
          poetry lock --no-update
          poetry install --with dev

      - name: Run Safety only
        run: poetry run bash scripts/security/run_python_sca.sh safety

      - name: Publicar artefatos SCA
        uses: actions/upload-artifact@v4
        with:
          name: python-sca
          path: artifacts/python-sca

