name: CI - Argo CD (seed_data)

on:
  pull_request:
    branches:
      - main
      - develop
      - 'feature/**'
      - 'release/**'
    paths:
      - 'infra/argocd/**'
      - 'infra/terraform/seed-data/**'
      - 'scripts/ci/validate-opa.sh'
      - '.github/workflows/ci-argo-seed-data.yml'
  push:
    branches:
      - main
      - develop
      - 'feature/**'
      - '[0-9][0-9][0-9]-*'
      - 'chore/**'
    paths:
      - 'infra/argocd/**'
      - 'infra/terraform/seed-data/**'
      - 'scripts/ci/validate-opa.sh'
      - '.github/workflows/ci-argo-seed-data.yml'
  workflow_dispatch: {}

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  changes:
    name: Changeset (IaC/Argo)
    runs-on: ubuntu-latest
    outputs:
      iac: ${{ steps.filter.outputs.iac }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - id: filter
        name: Detectar mudan√ßas relevantes
        uses: dorny/paths-filter@v3
        with:
          token: ${{ github.token }}
          filters: |
            iac:
              - 'infra/argocd/**'
              - 'infra/terraform/seed-data/**'
              - 'scripts/ci/validate-opa.sh'
              - '.github/workflows/ci-argo-seed-data.yml'

  argo:
    name: IaC/OPA + Kustomize (seed_data)
    runs-on: ubuntu-latest
    needs: changes
    if: ${{ needs.changes.outputs.iac == 'true' || github.event_name == 'workflow_dispatch' }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.7.5

      - name: Setup kubectl
        uses: azure/setup-kubectl@v4
        with:
          version: v1.30.0

      - name: Validar Terraform + OPA (seed_data)
        run: ./scripts/ci/validate-opa.sh

      - name: Renderizar kustomize (projeto/app seed_data)
        run: |
          kubectl kustomize infra/argocd/seed-data
          kubectl kustomize infra/argocd/seed-data/resources
